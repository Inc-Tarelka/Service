name: Build Mobile Platforms

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  pull_request:
    branches: [ main ]

jobs:
  android:
    name: Build Android
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
        
    - name: Grant execute permission for gradlew
      run: chmod +x app/gradlew
      
    - name: Build Android Debug
      run: cd app && ./gradlew :composeApp:assembleDebug --stacktrace
      
    - name: Upload Android APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: app/composeApp/build/outputs/apk/debug/*.apk
        retention-days: 14

  ios:
    name: Build iOS
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Grant execute permission for gradlew
      run: chmod +x app/gradlew
      
    - name: Build iOS Framework
      run: cd app && ./gradlew :composeApp:assembleXCFramework --stacktrace
      
    - name: Build iOS App (Simulator)
      run: |
        cd app/iosApp
        xcodebuild -project iosApp.xcodeproj \
          -scheme iosApp \
          -configuration Debug \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          build
      continue-on-error: true
      
    - name: Upload iOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-framework
        path: app/composeApp/build/XCFrameworks/
        retention-days: 14

  create-release:
    name: Create GitHub Release
    needs: [android, ios]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d-%H%M')" >> $GITHUB_OUTPUT
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.date.outputs.date }}
        name: Release ${{ steps.date.outputs.date }}
        draft: false
        prerelease: false
        files: |
          android-apk/*.apk
        body: |
          ## ðŸ“¦ Build ${{ github.run_number }}
          
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Date:** ${{ steps.date.outputs.date }}
          
          ### Artifacts
          - âœ… Android APK
          - âœ… iOS Framework
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


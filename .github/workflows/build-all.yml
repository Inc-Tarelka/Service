name: Build All Platforms

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  pull_request:
    branches: [ main ]

jobs:
  android:
    name: Build Android
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build Android Debug
      run: ./gradlew :composeApp:assembleDebug --stacktrace
      
    - name: Upload Android APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: composeApp/build/outputs/apk/debug/*.apk
        retention-days: 14

  ios:
    name: Build iOS
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build iOS Framework
      run: ./gradlew :composeApp:assembleXCFramework --stacktrace
      
    - name: Build iOS App (Simulator)
      run: |
        cd iosApp
        xcodebuild -project iosApp.xcodeproj \
          -scheme iosApp \
          -configuration Debug \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          build
      continue-on-error: true
      
    - name: Upload iOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-framework
        path: composeApp/build/XCFrameworks/
        retention-days: 14

  desktop:
    name: Build Desktop (JVM)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build Desktop App
      run: ./gradlew :composeApp:packageDistributionForCurrentOS --stacktrace
      
    - name: Upload Desktop Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: desktop-app
        path: composeApp/build/compose/binaries/main/
        retention-days: 14

  web:
    name: Build Web (JS/Wasm)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build JS Distribution
      run: ./gradlew :composeApp:jsBrowserDistribution --stacktrace
      
    - name: Build Wasm Distribution
      run: ./gradlew :composeApp:wasmJsBrowserDistribution --stacktrace
      
    - name: Upload Web Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-dist
        path: |
          composeApp/build/dist/js/productionExecutable/
          composeApp/build/dist/wasmJs/productionExecutable/
        retention-days: 14

  create-release:
    name: Create GitHub Release
    needs: [android, ios, desktop, web]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d-%H%M')" >> $GITHUB_OUTPUT
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.date.outputs.date }}
        name: Release ${{ steps.date.outputs.date }}
        draft: false
        prerelease: false
        files: |
          android-apk/*.apk
          desktop-app/**/*
        body: |
          ## ðŸ“¦ Build ${{ github.run_number }}
          
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Date:** ${{ steps.date.outputs.date }}
          
          ### Artifacts
          - âœ… Android APK
          - âœ… iOS Framework
          - âœ… Desktop App
          - âœ… Web Distribution
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

